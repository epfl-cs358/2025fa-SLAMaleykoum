# To run this file, run in a terminal this command: python mqtt_client.py
# You must have python installed and paho-mqtt (pip install paho-mqtt matplotlib)
import paho.mqtt.client as mqtt
import json
import math
import matplotlib.pyplot as plt

points = []

def on_message(client, userdata, msg):
    try:
        data = json.loads(msg.payload.decode())
        # Exemple attendu : [{"angle": 0, "distance": 100}, {"angle": 1, "distance": 98}, ...]
        for p in data:
            angle = math.radians(p["angle"])
            dist = p["distance"] / 100.0  # en m√®tres
            x = dist * math.cos(angle)
            y = dist * math.sin(angle)
            points.append((x, y))
    except Exception as e:
        print("Erreur:", e)

client = mqtt.Client()
client.connect("broker.hivemq.com", 1883)
client.subscribe("slamaleykoum77/lidardata")
client.on_message = on_message
client.loop_start()

plt.ion()
fig, ax = plt.subplots()
ax.set_xlim(-5, 5)
ax.set_ylim(-5, 5)

while True:
    if points:
        ax.clear()
        ax.set_xlim(-5, 5)
        ax.set_ylim(-5, 5)
        xs, ys = zip(*points[-360:])  # afficher les derniers points
        ax.scatter(xs, ys, s=5)
        plt.pause(0.1)