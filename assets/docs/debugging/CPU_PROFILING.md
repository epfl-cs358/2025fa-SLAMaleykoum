
üè† [Backlink to the main README](/README.md)

# CPU Profiling for ESP-1

## Overview

Real-time task profiling for ESP32 dual-core systems. Logs task execution events with microsecond precision to identify bottlenecks, mutex contention, and scheduling issues. In our case, to help us debug, we created our own profiling system to send the profiling data via TCP to our Ground Station.

**Why Profiling?**
- Detect CPU bottlenecks
- Debug mutex contention and deadlocks
- Validate task priorities and core pinning
- Prevent watchdog timer resets

## ESP1 Architecture

**8 FreeRTOS Tasks Across 2 Cores:**

| Core | Task ID | Name | Function |
|------|---------|------|----------|
| 1 | 1 | LIDAR | LiDAR data acquisition |
| 1 | 2 | SYNC | Pose-scan fusion |
| 1 | 3 | MAP | Bayesian grid updates |
| 0 | 4 | IPC | Inter-ESP communication |
| 0 | 5 | GPLAN | Global path planning |
| 0 | 6 | MPLAN | Mission planning |
| 0 | 7 | TCP | Telemetry transmission |
| 0 | 8 | VALID | Pose validation |

## How It Works

### 1. Event Logging (Firmware)

Each task logs START/END events to a circular buffer:

```cpp
void Bayesian_Grid_Task(void* parameter) {
    while (1) {
        log_event(ID_MAP, EVENT_START);  // Mark start
        
        // ... do work ...
        
        log_event(ID_MAP, EVENT_END);    // Mark end
        vTaskDelay(pdMS_TO_TICKS(50));
    }
}
```

**Data Structure (8 bytes/event):**
```cpp
struct TaskEvent {
    uint32_t timestamp_us;  // ESP32 micros()
    uint8_t task_id;        // 1-8
    uint8_t type;           // 1=START, 0=END
    uint8_t core_id;        // 0 or 1
    uint8_t padding;
};
```

### 2. TCP Transmission

The TCP task sends events to the ground station every 100ms. Uses critical sections to prevent race conditions during buffer copy.

### 3. Visualization

The ground station ([`ground_station.py`](/assets/docs/GROUND_STATION.md)) receives events and renders a live timeline showing task execution on both cores.

## Usage

### Quick Start

1. **Flash firmware** with profiling enabled (already included in your build)

2. **Connect to robot WiFi:**
   ```
   SSID: LIDAR_AP
   Password: l1darpass
   IP: 192.168.4.1
   ```

3. **Run ground station:**
   ```bash
   python ground_station.py
   ```

That's it! You'll see:
- Live map visualization
- Real-time task timeline (bottom of window)
- Task execution on both cores
- Performance metrics in HUD
- CSV log saved automatically

### What You'll See

**Timeline Panel (bottom):**
- Two horizontal lanes (Core 0 top, Core 1 bottom)
- Colored bars showing when each task runs
- Bar width = execution duration
- Gaps = task sleeping or blocked

**CSV Log:**
Automatically saved to `telemetry_trace_YYYYMMDD_HHMMSS.csv`:
```csv
Timestamp_PC,ESP_Time_us,Task_ID,Core,Event_Type
1702350445.123,1234567,3,1,1
1702350445.135,1246789,3,1,0
```

### Offline Analysis

Generate detailed Gantt charts from saved logs:

```bash
python plot_trace.py telemetry_trace_20241220_153045.csv
```

**Output:** High-resolution PNG showing task execution patterns

**Zoom to specific time window:**
```python
# In plot_trace.py:
ZOOM_WINDOW_SECONDS = 3.0    # Show 3 seconds
START_OFFSET_SECONDS = 2.0   # Starting at 2s mark
```

## Understanding the Output

### Live Timeline (Ground Station)

Note: Observe the lower part of the screen recording.
<p align="center"><img src="/assets/docs/debugging/illustrations/Live_Timeline_Example.gif" width=700></p>

- **Horizontal bars** = task execution
- **Bar color** = task type (see legend)
- **Bar width** = execution time
- **Vertical position** = task ID
- **Panel** = CPU core

### Gantt Chart (Offline Analysis)
![Gantt Chart](/assets/docs/debugging/illustrations/cpu_profiling_gantt_chart.png)

Once you zoom in on a specific area you see it a lot more clearly.
![Gantt Chart](/assets/docs/debugging/illustrations/cpu_profiling_gantt_chart_zoomed_in.png)

Generated by `plot_trace.py` - shows longer time periods with precise timing:

- X-axis: Time in milliseconds
- Y-axis: Tasks grouped by core
- Each bar shows exact start/end times
- Labels appear on bars >1ms wide

## Files

### Core System
- `main_esp1.cpp` - Task implementations + trace logging
- `data_types.h` - TaskEvent struct definition
- `ground_station.py` - Live visualization + CSV logging
- `plot_trace.py` - Offline Gantt chart generation

---

**Last Update**: December 2025